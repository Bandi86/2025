#!/usr/bin/env python3
"""
Optimaliz√°lt PDF feldolgoz√≥ - tiszta architekt√∫r√°val
"""

import os
import subprocess
import sqlite3
from pathlib import Path
from typing import List, Optional, Dict, Any
from datetime import datetime
import logging

from match_extractor import MatchExtractor, MatchData, MatchFormat

# Logging konfigur√°ci√≥
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class DatabaseManager:
    """Adatb√°zis kezel≈ë oszt√°ly"""

    def __init__(self, db_path: str = "data/optimized_sport_data.db"):
        self.db_path = Path(db_path)
        self.db_path.parent.mkdir(exist_ok=True)
        self.setup_database()

    def setup_database(self):
        """Adatb√°zis t√°bla l√©trehoz√°sa"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        cursor.execute('''
            CREATE TABLE IF NOT EXISTS matches (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                match_id TEXT NOT NULL,
                teams TEXT NOT NULL,
                time_info TEXT,
                day_info TEXT,
                odds_1 REAL,
                odds_2 REAL,
                odds_3 REAL,
                match_type TEXT,
                raw_line TEXT,
                source_pdf TEXT,
                line_number INTEGER,
                extracted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                UNIQUE(match_id, teams, source_pdf)
            )
        ''')

        conn.commit()
        conn.close()
        logger.info(f"Adatb√°zis inicializ√°lva: {self.db_path}")

    def save_matches(self, matches: List[MatchData], source_pdf: str) -> int:
        """Meccsek ment√©se adatb√°zisba"""
        if not matches:
            return 0

        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        saved_count = 0
        for match in matches:
            try:
                cursor.execute('''
                    INSERT OR IGNORE INTO matches
                    (match_id, teams, time_info, day_info, odds_1, odds_2, odds_3,
                     match_type, raw_line, source_pdf, line_number)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                ''', (
                    match.match_id,
                    match.teams,
                    match.time_info,
                    match.day_info,
                    match.odds[0],
                    match.odds[1],
                    match.odds[2],
                    match.match_type.value,
                    match.raw_line,
                    source_pdf,
                    match.line_number
                ))

                if cursor.rowcount > 0:
                    saved_count += 1

            except sqlite3.Error as e:
                logger.error(f"Hiba meccs ment√©sekor: {e}")
                continue

        conn.commit()
        conn.close()

        logger.info(f"Mentett meccsek: {saved_count}/{len(matches)}")
        return saved_count

    def get_statistics(self) -> Dict[str, Any]:
        """Adatb√°zis statisztik√°k"""
        conn = sqlite3.connect(self.db_path)
        cursor = conn.cursor()

        stats = {}

        # √ñsszes meccs
        cursor.execute("SELECT COUNT(*) FROM matches")
        stats['total_matches'] = cursor.fetchone()[0]

        # PDF forr√°sok
        cursor.execute("SELECT COUNT(DISTINCT source_pdf) FROM matches")
        stats['total_pdfs'] = cursor.fetchone()[0]

        # Form√°tum szerinti bont√°s
        cursor.execute("SELECT match_type, COUNT(*) FROM matches GROUP BY match_type")
        stats['by_format'] = dict(cursor.fetchall())

        # Legut√≥bbi kinyer√©s
        cursor.execute("SELECT MAX(extracted_at) FROM matches")
        stats['last_extraction'] = cursor.fetchone()[0]

        conn.close()
        return stats

class PDFTextExtractor:
    """PDF sz√∂veg kinyer≈ë oszt√°ly"""

    def __init__(self, timeout: int = 30):
        self.timeout = timeout
        self._check_pdftotext()

    def _check_pdftotext(self):
        """Ellen≈ërzi, hogy a pdftotext el√©rhet≈ë-e"""
        try:
            subprocess.run(['pdftotext', '-v'], capture_output=True, check=True)
        except (subprocess.CalledProcessError, FileNotFoundError):
            raise RuntimeError("pdftotext nem el√©rhet≈ë. Telep√≠tsd: sudo apt-get install poppler-utils")

    def extract_text(self, pdf_path: Path) -> Optional[str]:
        """Sz√∂veg kinyer√©se PDF-b≈ël"""
        try:
            logger.info(f"PDF sz√∂veg kinyer√©se: {pdf_path.name}")

            result = subprocess.run(
                ['pdftotext', '-layout', str(pdf_path), '-'],
                capture_output=True,
                text=True,
                timeout=self.timeout
            )

            if result.returncode == 0:
                text_length = len(result.stdout)
                logger.info(f"Sz√∂veg kinyerve: {text_length} karakter")
                return result.stdout
            else:
                logger.error(f"pdftotext hiba: {result.stderr}")
                return None

        except subprocess.TimeoutExpired:
            logger.error(f"Timeout ({self.timeout}s) - PDF t√∫l nagy: {pdf_path.name}")
            return None
        except Exception as e:
            logger.error(f"Kiv√©tel: {e}")
            return None

class SzerencseMixProcessor:
    """F≈ë feldolgoz√≥ oszt√°ly - tiszta architekt√∫r√°val"""

    def __init__(self, db_path: str = "data/optimized_sport_data.db"):
        self.extractor = MatchExtractor()
        self.pdf_extractor = PDFTextExtractor()
        self.db_manager = DatabaseManager(db_path)

        logger.info("SzerencseMix Processor inicializ√°lva")

    def process_pdf(self, pdf_path: Path) -> Dict[str, Any]:
        """Egy PDF teljes feldolgoz√°sa"""
        logger.info(f"PDF feldolgoz√°s kezd√©se: {pdf_path.name}")

        # 1. Sz√∂veg kinyer√©se
        text = self.pdf_extractor.extract_text(pdf_path)
        if not text:
            return {'error': 'Sz√∂veg kinyer√©s sikertelen', 'pdf': pdf_path.name}

        # 2. Meccsek keres√©se
        matches = self.extractor.extract_from_text(text)
        logger.info(f"Tal√°lt meccsek: {len(matches)}")

        # 3. Adatb√°zisba ment√©s
        saved_count = self.db_manager.save_matches(matches, pdf_path.name)

        # 4. Statisztik√°k
        match_stats = self.extractor.get_statistics(matches)

        result = {
            'pdf': pdf_path.name,
            'total_matches': len(matches),
            'saved_matches': saved_count,
            'text_length': len(text),
            'statistics': match_stats,
            'success': True
        }

        logger.info(f"PDF feldolgoz√°s k√©sz: {saved_count} meccs mentve")
        return result

    def process_directory(self, directory: Path, pattern: str = "*.pdf") -> List[Dict[str, Any]]:
        """Mappa √∂sszes PDF-j√©nek feldolgoz√°sa"""
        pdf_files = list(directory.glob(pattern))

        if not pdf_files:
            logger.warning(f"Nincsenek PDF f√°jlok: {directory}")
            return []

        logger.info(f"PDF f√°jlok feldolgoz√°sa: {len(pdf_files)} f√°jl")

        results = []
        for pdf_path in pdf_files:
            try:
                result = self.process_pdf(pdf_path)
                results.append(result)
            except Exception as e:
                logger.error(f"Hiba {pdf_path.name} feldolgoz√°sakor: {e}")
                results.append({
                    'pdf': pdf_path.name,
                    'error': str(e),
                    'success': False
                })

        return results

    def get_summary(self) -> Dict[str, Any]:
        """Feldolgoz√°s √∂sszes√≠t≈ëje"""
        return self.db_manager.get_statistics()

def find_pdf_files() -> List[Path]:
    """PDF f√°jlok keres√©se a projekt mapp√°kban"""
    search_dirs = [
        Path("../../pdf/organized"),  # √öj √∫tvonal a reorganiz√°lt strukt√∫r√°hoz
        Path("pdf_processed"),
        Path("pdf_input"),
        Path("."),
    ]

    pdf_files = []
    for directory in search_dirs:
        if directory.exists():
            pdf_files.extend(directory.rglob("*.pdf"))

    return sorted(list(set(pdf_files)))  # Duplik√°tumok elt√°vol√≠t√°sa √©s rendez√©s

def process_single_pdf(pdf_path: str):
    """Egyetlen PDF f√°jl feldolgoz√°sa"""
    print("üöÄ EGYETLEN PDF FELDOLGOZ√ÅSA")
    print("="*50)

    try:
        processor = SzerencseMixProcessor()

        pdf_file = Path(pdf_path)
        if not pdf_file.exists():
            print(f"‚ùå A PDF f√°jl nem tal√°lhat√≥: {pdf_path}")
            return

        print(f"üìÑ Feldolgoz√°s: {pdf_file.name}")

        # Feldolgoz√°s
        result = processor.process_pdf(pdf_file)

        if result.get('success'):
            print(f"‚úÖ {result['pdf']}: {result['saved_matches']} meccs mentve")
        else:
            print(f"‚ùå {result['pdf']}: {result.get('error', 'Ismeretlen hiba')}")

        # √ñsszes√≠t≈ë statisztik√°k
        summary = processor.get_summary()
        print("\n" + "="*50)
        print("üìä STATISZTIK√ÅK")
        print("="*50)
        print(f"üèÖ Mentett meccset: {result.get('saved_matches', 0)}")
        print(f"üíæ Adatb√°zis: {processor.db_manager.db_path}")
        print("‚úÖ Feldolgoz√°s befejezve!")

    except Exception as e:
        logger.error(f"Kritikus hiba: {e}")
        print(f"‚ùå Kritikus hiba: {e}")

def main():
    """F≈ë fut√°si logika"""
    print("üöÄ OPTIMALIZ√ÅLT SZERENCSMIX PROCESSOR")
    print("="*50)

    try:
        processor = SzerencseMixProcessor()

        # PDF f√°jlok keres√©se
        pdf_files = find_pdf_files()

        if not pdf_files:
            print("‚ùå Nincsenek PDF f√°jlok!")
            return

        print(f"üìö Tal√°lt PDF f√°jlok: {len(pdf_files)}")

        # Feldolgoz√°s
        results = []
        for pdf_path in pdf_files[:3]:  # Els≈ë 3 PDF tesztel√©se
            result = processor.process_pdf(pdf_path)
            results.append(result)

            if result.get('success'):
                print(f"‚úÖ {result['pdf']}: {result['saved_matches']} meccs")
            else:
                print(f"‚ùå {result['pdf']}: {result.get('error', 'Ismeretlen hiba')}")

        # √ñsszes√≠t≈ë statisztik√°k
        summary = processor.get_summary()

        print("\n" + "="*50)
        print("üìä V√âGS≈ê STATISZTIK√ÅK")
        print("="*50)
        print(f"üìÑ Feldolgozott PDF-ek: {summary['total_pdfs']}")
        print(f"üèÖ √ñsszes meccs: {summary['total_matches']}")
        print("üè∑Ô∏è  Form√°tumok szerint:")
        for format_type, count in summary['by_format'].items():
            print(f"   {format_type}: {count}")

        if summary['last_extraction']:
            print(f"‚è∞ Utols√≥ kinyer√©s: {summary['last_extraction']}")

        print(f"\nüíæ Adatb√°zis: {processor.db_manager.db_path}")
        print("‚úÖ Feldolgoz√°s befejezve!")

    except Exception as e:
        logger.error(f"Kritikus hiba: {e}")
        print(f"‚ùå Kritikus hiba: {e}")

if __name__ == "__main__":
    main()
